# アプリケーションロジック (Core Logic)

**文書バージョン**: 1.0.0
**最終更新日**: 2025-12-13
**対象バージョン**: 1.0.2

## 1. 概要
本ドキュメントは、アプリケーションのコアとなるロジック、計算処理、およびデータの永続化に関する仕様を定義する。

## 2. 定義と前提
### 2.1 関連ドキュメント
- [00_System_Overview.md](./00_System_Overview.md)
- [01_Data_Models.md](./01_Data_Models.md)

## 3. 詳細仕様

### 3.1 データ永続化 (Persistence)
Zustandの `persist` ミドルウェアを使用し、アプリケーションの状態を `localStorage` に自動保存する。

- **Storage Key**: `trpg-scenario-manager-storage`
- **保存対象**:
  - ノード (`nodes`), エッジ (`edges`)
  - ゲーム状態 (`gameState`)
  - ビューポート (`viewport`)
  - マスタデータ (`characters`, `resources`)
  - 設定 (`theme`, `language`, `edgeType`)
- **ロード時の処理**:
  - 無効な座標(`NaN`)を持つノードの除外
  - 選択状態のリセット
- **リセット処理**:
  1. 全データをクリア
  2. 初期状態（「注意事項」メモノードのみ）を生成
  3. 画面を初期位置にフィット

### 3.2 ゲーム状態計算 (Game State Calculation)

#### 3.2.1 変数評価 (`Variable Evaluation`)
- **式評価**: 変数ノードや条件分岐において `${VarName}` 形式の変数を再帰的に展開・評価する。
  - 制限: 最大再帰深度 10, 最大長 100,000文字
  - 安全性: 数式チェック後、`new Function()` で実行
- **Variableノードの公開挙動 (Reveal/Unreveal)**:
  - **Reveal (公開)**: 現在の値を保存し (`previousValue`)、新しい値（式評価結果）で変数を更新する。
  - **Unreveal (非公開)**: `previousValue` から元の値を復元する。
  - **楽観的更新**: ストア更新の遅延によるちらつきを防ぐため、UI上では即座に値を反映する。

#### 3.2.2 リソースマッピング
Elementノードがアクティブになった際、以下のマッピングルールに基づいて `GameState` の各カテゴリに反映される。
- `Item` -> `inventory`
- `Equipment` -> `equipment`
- `Knowledge` -> `knowledge`
- `Skill` -> `skills`
- `Status` -> `stats`

### 3.3 データ検証 (Validation)

#### 3.3.1 シナリオ検証
ロード時およびエクスポート時に以下の検証を行う。
- **必須配列**: `nodes`, `edges` の存在確認。
- **ノード検証**: ID欠落時は自動生成。Type不正時は `event` に補正。Position欠落時は `{x:0, y:0}` に補正。
- **エッジ検証**: 孤立したエッジ（存在しないノードIDへの参照）の削除。

#### 3.3.2 変数検証
- **一意性**: 変数名の重複（Case-insensitive）を禁止し、重複時は古い定義を破棄または警告。
- **型整合性**: 定義された型(`string`, `number`, `boolean`)と値の整合性をチェック。
- **不変性**: 作成後の変数型の変更はUI上でブロックする（参照整合性維持のため）。

#### 3.3.3 リファクタリング機能
変数名の変更時、以下の参照箇所の変数名を一括置換する。
- ノードラベル、説明文
- 分岐条件、Variableノードのターゲット等

#### 3.3.4 入力制限 (Input Limits)
- **ズームレベル**: 最小 1% (0.01) ～ 最大 200% (2.0)。
- **数式評価**: 数値 (0-9)、四則演算子 (+, -, *, /)、括弧 `()`、小数点 `.` および空白のみを許可。これ以外の文字が含まれる場合は文字列として扱われる。

### 3.4 ノード固有ロジック (Node Logic)

#### 3.4.1 自動補正 (Auto-healing)
- **Variableノード**: `targetVariable` が未設定または削除された変数を参照している場合、存在する変数の中から自動的に（最初の候補を）再割り当てする。
- **Jumpノード**: `jumpTarget` が未設定の場合、存在するノードの中から自動的に（最初の候補を）再割り当てする。
- **トリガー**: ノードのレンダリング時（`useEffect`）にチェックし、必要であれば非同期でストアを更新する。

### 3.5 グループ化ロジック (Grouping)

#### 3.5.1 グループ作成
- 選択されたノードのバウンディングボックス + パディング(20px) で新規グループを作成。
- 注: 付箋ノードはグループ化から除外される。

#### 3.5.2 ドラッグ＆ドロップ挙動
- ノード移動時、グループとの交差判定を行う。
- 最も内側（面積が小さい）のグループに所属させる（Reparenting）。
- グループ移動の際は、内部のノードおよびそれに付随する付箋も追従する。

#### 3.5.3 重なり解決 (Overlap Resolution)
- グループ展開時など、兄弟グループ同士が重ならないように自動的に位置を調整する（Push Logic）。
- 優先方向: 下(+Y) または 右(+X)。

#### 3.5.4 折りたたみ/展開 (Collapse/Expand)
- **Collapse**:
  - 子ノードを非表示にし、グループサイズをコンテンツサイズ（または最小 150x50px）に縮小する。
  - 外部ノードとの接続がある場合、一時的な「仮想エッジ（破線）」を表示して関係性を維持する。
- **Expand**:
  - 子ノードの表示を復元し、バウンディングボックスに基づいてサイズを再計算する。
  - 展開時に兄弟グループと重なる場合、Push Logic により周囲のノードを押し広げる。

### 3.6 ローカライズ (Localization)
- **戦略**: Markdownベースのコンテンツ管理。
- **仕組み**: `public/[File].md` (Manual, ChangeLog等) を非同期でフェッチし、セクションマーカー (`<!-- SECTION: ja/en -->`) に基づいてパース・キャッシュする。
- **利点**: 言語切り替え時のちらつき防止と、コードベースからのコンテンツ分離。

### 3.7 アイテム操作ルール (Item Operations)
#### 3.7.1 削除カスケード (Deletion Cascade)
ノード削除時、整合性を保つため以下の関連要素も自動的に削除される。
- **親ノード削除**: 子孫ノードも再帰的に削除される。
- **ターゲット削除**: そのノードを参照している `Jump` ノード、`Sticky` ノードも削除される。
- **エッジ削除**: 削除されたノードに接続するエッジは全て削除される。

### 3.8 プレイモード制限 (Play Mode Restrictions)
編集モード(`edit`)と比較して、以下の操作が制限される。
- **移動**: ノードのドラッグ自体は可能（UI上のインタラクション維持のため）だが、座標の更新はブロックされる（付箋を除く）。
- **コンテキストメニュー**: 編集用のアクション（削除、複製など）が非表示になり、プレイ用のアクション（付箋追加など）のみとなる。

### 3.9 ファイル入出力 (File I/O)
- **エクスポート形式**: JSON
- **ファイル名規則**: `TRPGScenarioManager_YYYYMMDDHHmmssSSS.json`
- **インポート挙動**: 既存のキャンバスをクリアし、ロードしたデータで上書きする（確認ダイアログを表示）。

---
*End of Document*
