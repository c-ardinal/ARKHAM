# デバッグ機能拡張 仕様書

## 概要
TRPGシナリオマネージャーのデバッグ機能を拡張し、開発者およびAIエージェントによる問題診断を効率化する。

## 機能一覧

### 1. パフォーマンスモニター
**目的**: レンダリング性能とメモリ使用状況の可視化

#### 1.1 計測項目
- **コンポーネントレンダリング回数**
  - 主要コンポーネント(Canvas, PropertyPanel, Sidebar等)のレンダリング回数をカウント
  - 1秒あたりのレンダリング回数(RPS: Renders Per Second)を表示
  
- **レンダリング時間**
  - 各コンポーネントのレンダリング開始から完了までの時間(ms)
  - 平均値、最小値、最大値を記録
  
- **メモリ使用量**
  - `performance.memory` APIを使用(Chrome/Edge限定)
  - `usedJSHeapSize`, `totalJSHeapSize`, `jsHeapSizeLimit`を取得
  - 非対応ブラウザでは「N/A」と表示
  
- **FPS(フレームレート)**
  - `requestAnimationFrame`を使用してFPSを計測
  - リアルタイム表示(1秒ごとに更新)

#### 1.2 データ構造
```typescript
interface PerformanceMetrics {
  componentRenders: Record<string, {
    count: number;
    avgTime: number;
    minTime: number;
    maxTime: number;
    lastRenderTime: number;
  }>;
  memory: {
    usedJSHeapSize: number;
    totalJSHeapSize: number;
    jsHeapSizeLimit: number;
  } | null;
  fps: number;
  timestamp: number;
  localStorage: {
    used: number;      // 使用バイト数
    quota: number;     // 割り当て容量(通常5MB〜10MB)
    percentage: number; // 使用率(%)
  } | null;
}
```

#### 1.3 UI表示
- リアルタイム更新(500ms間隔)
- グラフ表示は初期実装では不要(数値のみ)
- 警告表示: FPS < 30 または メモリ使用率 > 80%で警告色
- **LocalStorage使用率**:
  - 使用量 / 割り当て容量を表示(例: "2.5 MB / 5 MB (50%)")
  - 使用率 > 80%で警告色
- **コンポーネントレンダリングクリアボタン**:
  - 計測データをリセットして再計測開始
  - ボタンラベル: "計測データをクリア"


---

### 2. フィルタリング・検索機能
**目的**: 大量のログから必要な情報を素早く抽出

#### 2.1 フィルタ種別
- **ログレベルフィルタ**
  - チェックボックス形式: `[✓] Log` `[✓] Warn` `[✓] Error` `[✓] Info`
  - 複数選択可能
  
- **キーワード検索**
  - テキスト入力フィールド
  - 部分一致検索(大文字小文字を区別しない)
  - 正規表現対応(オプション: チェックボックスで有効化)
  
- **タグフィルタ**
  - ログメッセージ内の`[Viewport]`, `[DEBUG]`等のタグを自動抽出
  - タグ一覧をドロップダウンで表示し選択可能
  
- **時間範囲フィルタ**
  - 開始時刻・終了時刻を指定(時:分:秒形式)
  - 「最新100件」「最新500件」などのプリセットボタン

#### 2.2 UI配置
- デバッグモーダルの上部にフィルタバーを配置
- フィルタ適用後のログ件数を表示(例: "1,234件中 56件を表示")

---

### 3. アサーション機能
**目的**: 期待される状態との差異を自動検出

#### 3.1 アサーションルール
```typescript
interface AssertionRule {
  id: string;
  name: string;
  description: string;
  condition: (state: ScenarioState) => boolean;
  severity: 'info' | 'warning' | 'error';
  enabled: boolean;
}
```

#### 3.2 デフォルトルール
1. **開始ノード存在チェック**
   - 条件: `nodes.filter(n => n.data.isStart).length === 0`
   - 重要度: warning
   - メッセージ: "開始ノードが設定されていません"

2. **孤立ノード検出**
   - 条件: エッジに接続されていないノード(付箋・メモを除く)
   - 重要度: info
   - メッセージ: "孤立したノードが存在します: {nodeIds}"

3. **変数未定義参照**
   - 条件: `${VarName}`形式で参照されているが未定義の変数
   - 重要度: error
   - メッセージ: "未定義の変数が参照されています: {varNames}"

4. **循環参照検出**
   - 条件: エッジが循環している(無限ループの可能性)
   - 重要度: warning
   - メッセージ: "循環参照が検出されました"

5. **ジャンプノードターゲット不正**
   - 条件: `jumpTarget`が存在しないノードを指している
   - 重要度: error
   - メッセージ: "ジャンプノードのターゲットが不正です: {nodeIds}"

#### 3.3 実行タイミング
- 手動実行: デバッグモーダル内の「アサーション実行」ボタン
- 自動実行: ストア更新時(debounce 1秒)
- 結果はログに出力 + 専用タブに一覧表示

- 結果はログに出力 + 専用タブに一覧表示

#### 3.4 カスタムルール (Dynamic Assertion)
- **UI**: 「アサーションタブ」から動的にルールを追加可能
- **形式**: JavaScriptコード (`state`引数を受け取り`boolean`を返す関数本体)
- **セキュリティ**: `new Function` を使用して実行されるため、開発者自身の責任において使用する
- **永続化**: 現在の実装ではブラウザリロードで消失する（一時的な利用を想定）

---

### 4. 状態スナップショット
**目的**: 特定時点でのアプリケーション状態を保存・確認

#### 4.1 スナップショット内容
```typescript
interface StateSnapshot {
  timestamp: string; // ISO 8601形式
  nodes: ScenarioNode[];
  edges: ScenarioEdge[];
  gameState: GameState;
  characters: CharacterData[];
  resources: ResourceData[];
  viewport: { x: number; y: number; zoom: number } | null;
  mode: 'edit' | 'play';
  // 機密データマスキング済み
}
```

#### 4.2 機密データマスキング
以下のフィールドは`"***MASKED***"`に置換:
- LocalStorageの生データ(キー名のみ表示)
- 将来的に追加される可能性のある認証トークン等

#### 4.3 UI
- 「スナップショット作成」ボタン
- スナップショット一覧(最大10件保持、古いものから自動削除)
- 各スナップショットをJSON形式で表示(折りたたみ可能)
- 差分表示機能(2つのスナップショットを選択して比較)

#### 4.4 永続化 (Persistence)
- スナップショットデータおよびUI状態（比較モード、選択状態）は `LocalStorage` に保存される
- ブラウザのリロードやタブ切り替えを行ってもデータは維持される
- 比較モード中にタブを移動しても、元の状態に復帰可能

---

### 5. 状態スナップショットエクスポート
**目的**: スナップショットをファイルとして保存

#### 5.1 エクスポート設定
- **データ種別選択**(チェックボックス):
  - `[✓] ノード・エッジ`
  - `[✓] ゲーム状態`
  - `[✓] キャラクター`
  - `[✓] リソース`
  - `[✓] ビューポート`
  - `[ ] LocalStorage全体` ← デフォルトOFF

#### 5.2 警告表示
エクスポート実行前に確認ダイアログを表示:
```
⚠️ 警告
エクスポートされるデータには、シナリオの内容や設定情報が含まれます。
このファイルを第三者と共有する際は、機密情報が含まれていないか確認してください。

[キャンセル] [エクスポート実行]
```

#### 5.3 ファイル形式
- ファイル名: `DebugSnapshot_YYYYMMDDHHmmssSSS.json`
- 内容: 選択されたデータのみを含むJSON

---

### 6. ログエクスポート
**目的**: ログをファイルとして保存

#### 6.1 エクスポート設定
- 現在のフィルタ設定を反映(フィルタ後のログのみエクスポート)
- または「全ログをエクスポート」オプション

#### 6.2 警告表示
```
⚠️ 警告
エクスポートされるログには、アプリケーションの動作情報が含まれます。
デバッグ目的以外での使用は推奨されません。

[キャンセル] [エクスポート実行]
```

#### 6.3 ファイル形式
- ファイル名: `DebugLog_YYYYMMDDHHmmssSSS.txt`
- 内容: プレーンテキスト(各行: `timestamp [LEVEL] message`)

---

## UI/UX仕様

### デスクトップ版

#### パターンA: フローティングウィンドウ(優先)
- **実装方法**: `react-rnd`ライブラリを使用
- **初期位置**: 画面左上(x: 20px, y: 80px) ← ヘッダー下
- **初期サイズ**: 600px × 400px
- **最小サイズ**: 400px × 300px
- **機能**:
  - ドラッグで移動可能
  - リサイズハンドル(右下・右・下)
  - 最小化ボタン(タイトルバーに格納)
  - 閉じるボタン
- **z-index**: 200(モーダルより下、他のUI要素より上)

#### パターンB: サイドパネル(フローティング不可の場合)
- **配置**: Canvasの右側(PropertyPanelがある場合はその右)
- **幅**: 400px(固定)
- **高さ**: ビューポート高さ - ヘッダー高さ
- **リサイズ**: 左端をドラッグして幅を調整可能(300px〜600px)

### モバイル版

#### レイアウト
- **表示方法**: フルスクリーンモーダル
- **z-index**: 10000(最前面)
- **背景**: 半透明オーバーレイ(`bg-black/50`)

#### タブ構成
- タブバー(画面上部):
  - `ログ` `パフォーマンス` `スナップショット` `アサーション`
- スワイプでタブ切り替え可能

#### 最適化
- ログ表示: 仮想スクロール(`react-window`使用)で大量ログに対応
- フィルタ: アコーディオン形式で折りたたみ可能
- タッチ操作: ボタンサイズ最小44px × 44px

---

## データフロー

### パフォーマンスモニター
```
Component Render
  ↓
useEffect (計測開始)
  ↓
Performance API
  ↓
DebugStore.addMetrics()
  ↓
UI更新(500ms間隔)
```

### アサーション
```
ScenarioStore更新
  ↓
debounce(1000ms)
  ↓
AssertionEngine.run()
  ↓
ルール評価
  ↓
結果をログ + AssertionStore保存
  ↓
UI更新
```

---

## セキュリティ考慮事項

### 機密データマスキング
- LocalStorageの生データは表示しない(キー名のみ)
- 将来的な拡張で追加される可能性のある認証情報フィールドを想定

### エクスポート時の警告
- ユーザーに明示的な確認を求める
- データ種別を選択可能にし、不要な情報の漏洩を防ぐ

### ブラウザ内完結
- すべてのデバッグデータはブラウザ内でのみ処理
- 外部サーバーへの送信は一切行わない

---

## 技術スタック

### 新規依存ライブラリ
- `react-rnd`: フローティングウィンドウ実装(デスクトップ)
- `react-window`: 仮想スクロール(モバイル最適化)

### 既存ライブラリ活用
- `zustand`: DebugStore作成
- `lucide-react`: アイコン
- `tailwindcss`: スタイリング

---

## ファイル構成

```
src/
├── store/
│   └── debugStore.ts          # デバッグ用ストア
├── components/
│   ├── DebugModal.tsx         # 既存(拡張)
│   ├── DebugPanel/
│   │   ├── DebugPanel.tsx     # メインコンポーネント
│   │   ├── LogTab.tsx         # ログタブ
│   │   ├── PerformanceTab.tsx # パフォーマンスタブ
│   │   ├── SnapshotTab.tsx    # スナップショットタブ
│   │   └── AssertionTab.tsx   # アサーションタブ
│   └── common/
│       └── FloatingWindow.tsx # フローティングウィンドウ(共通)
├── utils/
│   ├── performanceMonitor.ts  # パフォーマンス計測
│   ├── assertionEngine.ts     # アサーション実行
│   └── debugExport.ts         # エクスポート処理
└── types/
    └── debug.ts               # デバッグ関連型定義
```

---

## 実装優先順位

### Phase 1: 基盤整備
1. DebugStore作成
2. FloatingWindow実装(デスクトップ)
3. DebugPanel基本構造

### Phase 2: コア機能
4. フィルタリング・検索機能
5. パフォーマンスモニター
6. 状態スナップショット

### Phase 3: 高度な機能
7. アサーション機能
8. エクスポート機能(警告付き)
9. モバイル最適化

---

## テスト項目

### 機能テスト
- [ ] ログフィルタが正しく動作する
- [ ] パフォーマンスメトリクスが正確に計測される
- [ ] スナップショットが正しく保存・復元される
- [ ] アサーションルールが正しく評価される
- [ ] エクスポートファイルが正しい形式で生成される

### UI/UXテスト
- [ ] デスクトップ: フローティングウィンドウが正常に動作
- [ ] デスクトップ: リサイズ・移動が滑らか
- [ ] モバイル: タブ切り替えがスムーズ
- [ ] モバイル: タッチ操作が快適

### セキュリティテスト
- [ ] 機密データがマスキングされている
- [ ] エクスポート時に警告が表示される
- [ ] 外部への通信が発生しない

---

## 補足事項

### パフォーマンスへの影響
- パフォーマンスモニター自体がパフォーマンスに影響を与えないよう、計測処理は最小限に
- デバッグモード無効時は完全に無効化(オーバーヘッドゼロ)

### 将来的な拡張
- ネットワークモニター(ローカルファイルI/Oのみ、認証情報除外)
- スナップショット間の詳細差分表示(ビジュアル化の強化)
- カスタムルールの永続化対応 (セキュリティリスクを考慮した設計が必要)
