{
  "image-graph-link": {
    "state_transition": "RequirementSpecification_Image_Graph.md#state-transition-diagram",
    "layout_matrix": "RequirementSpecification_Image_Graph.md#layout-interaction-matrix"
  },
  "visuals": {
    "color_palette_hsl_definitions": {
      "light": {
        "background": "210 40% 98% (Slate-50)",
        "foreground": "222 47% 11% (Slate-900)",
        "card": "0 0% 100% (White)",
        "popover": "0 0% 100% (White)",
        "primary": "221 83% 53% (Blue-600)",
        "secondary": "210 40% 96.1% (Slate-100)",
        "muted": "210 40% 96.1% (Slate-100)",
        "accent": "210 40% 96.1% (Slate-100)",
        "destructive": "0 84.2% 60.2% (Red-500)",
        "border": "214.3 31.8% 91.4% (Slate-200)",
        "input": "214.3 31.8% 91.4% (Slate-200)",
        "ring": "221 83% 53% (Blue-600)"
      },
      "dark": {
        "background": "222 47% 11% (Slate-900)",
        "foreground": "210 40% 98% (Slate-50)",
        "card": "215 28% 17% (Slate-800)",
        "popover": "215 28% 17% (Slate-800)",
        "primary": "217 91% 60% (Blue-500)",
        "secondary": "215 28% 17% (Slate-800)",
        "muted": "215 28% 17% (Slate-800)",
        "accent": "215 25% 27% (Slate-700)",
        "destructive": "0 62.8% 30.6% (Red-900)",
        "border": "215 25% 27% (Slate-700)",
        "input": "215 25% 27% (Slate-700)",
        "ring": "224 76% 48% (Blue-700)"
      }
    },
    "node_colors_hardcoded": {
      "event": "orange-100 / orange-900 (テキスト: orange-700/100)",
      "element": "blue-100 / blue-900 (テキスト: blue-700/100)",
      "branch": "purple-100 / purple-900 (テキスト: purple-700/100)",
      "variable": "red-100 / red-900 (テキスト: red-700/100)",
      "group": "slate-200 / slate-700 (テキスト: slate-700/200)",
      "jump": "yellow-100 / yellow-900 (テキスト: yellow-700/100)",
      "memo": "white / gray-800 (テキスト: gray-700/200)",
      "character": "yellow-100 / yellow-900 (テキスト: yellow-700/100)",
      "resource": "green-100 / green-900 (テキスト: green-700/100)",
      "default": "gray-100 / gray-800"
    },
    "z_indices": {
      "mobile_drag_ghost": 2500,
      "sticky_nodes": 2001,
      "sticky_edges": 2000,
      "modals": 150,
      "confirmation_modal": 100,
      "mobile_property_panel": 60,
      "mobile_sidebar": 60,
      "header": 50,
      "context_menu": 50,
      "sidebar": 40,
      "canvas_nodes": 0,
      "canvas_group_nodes": -1
    },
    "visual_indicators": {
      "node_status": [
        {
          "state": "公開済み (Revealed)",
          "condition": "data.revealed == true",
          "position": "左上 (-8px, -8px)",
          "visual": "緑の円 (bg-green-500) に白いチェックマーク"
        },
        {
          "state": "付箋あり (Has Sticky)",
          "condition": "data.hasSticky == true",
          "position": "右上 (-20px, -20px)",
          "visual": "黄色の正方形 (bg-yellow-400), 6度回転, 影付き (Shadow-md)"
        },
        {
          "state": "開始ノード (Start Node)",
          "condition": "data.isStart == true",
          "position": "ラベルの左",
          "visual": "金色の星 (text-yellow-500)"
        }
      ]
    },
    "mobile_specific_styles": {
      "react_flow_handle": "幅/高さを14pxに強制（標準より拡大）、ヒットエリアを拡張",
      "touch_action": "ノード上で 'none !important' を指定し、スクロールを防止",
      "text_selection": "入力フィールドを除くほぼすべてのUI要素で無効化"
    }
  },
  "logic": {
    "game_state_calculation": {
      "resource_mapping": {
        "logic": "すべての要素(Element)/情報(Information)ノードをスキャン。リソースを参照している場合、タイプを状態カテゴリにマッピング。",
        "mappings": [
          { "resource_type": "Item", "target_state": "inventory" },
          { "resource_type": "Equipment", "target_state": "equipment" },
          { "resource_type": "Knowledge", "target_state": "knowledge" },
          { "resource_type": "Skill", "target_state": "skills" },
          { "resource_type": "Status", "target_state": "stats" },
          { "default": "knowledge" }
        ]
      },
      "variable_evaluation": {
        "mechanism": "再帰的な正規表現による置換 (${var}) -> 数式チェック -> new Function() の実行 (比較的安全な方法)",
        "limits": "最大再帰深度 10, 最大文字列長 100,000"
      },
      "variable_nodes": {
        "reveal_behavior": "現在の変数値を 'previousValue' に保存し、新しい値の式を評価して変数を更新。",
        "unreveal_behavior": "'previousValue' から変数値を復元し、'previousValue' をクリア。"
      }
    },
    "grouping_logic": {
      "creation": {
        "padding": "選択されたノードのバウンディングボックスの周囲20px",
        "restriction": "付箋ノードはグループ化から除外"
      },
      "drag_drop": {
        "detection": "すべてのグループとの交差面積を計算。",
        "priority": "グループ面積の昇順でソート（最も内側のグループにドロップ）。",
        "action": "ノードの親を変更(Reparent)し、グループサイズを更新し、内部の重なりを解決。"
      },
      "overlap_resolution": {
        "algorithm": "反復プッシュ (最大500回)。",
        "direction": "重なりの中心ベクトルに基づいて下(+Y)または右(+X)を優先。",
        "cascade": "プッシュされるノードと共に子孫ノードと付箋も移動。"
      },
      "collapse_expand": {
        "collapse": "子ノードを非表示にし、グループサイズをコンテンツサイズ（または最小150x50）に設定。外部接続用に「仮想エッジ（破線）」を作成。",
        "expand": "子ノードの表示を復元し、サイズを再計算し、重なっている兄弟ノードを押しのける（プッシュダウン/ライトロジック）。"
      }
    }
  },
  "node_definitions": {
    "event": {
      "label": "イベント (Event)",
      "description": "シナリオの基本単位となるノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "description", "type": "string", "description": "詳細テキスト" },
        { "key": "isStart", "type": "boolean", "description": "開始ノードフラグ" }
      ]
    },
    "element": {
      "label": "要素 (Element / Information)",
      "description": "アイテムや知識の獲得・消費を扱うノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "infoType", "type": "enum", "options": ["knowledge", "item", "skill", "stat", "equipment"], "description": "リソースタイプ" },
        { "key": "infoValue", "type": "string", "description": "リソース名 (値)" },
        { "key": "quantity", "type": "number", "description": "数量" },
        { "key": "actionType", "type": "enum", "options": ["obtain", "consume"], "description": "アクション (獲得/消費)" }
      ]
    },
    "branch": {
      "label": "分岐 (Branch)",
      "description": "条件によってストーリーを分岐させるノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "branchType", "type": "enum", "options": ["if_else", "switch"], "description": "分岐タイプ" },
        { "key": "branches", "type": "array", "description": "分岐先リスト (Switch用)" },
        { "key": "conditionVariable", "type": "string", "description": "条件変数" },
        { "key": "conditionValue", "type": "string", "description": "比較値" }
      ]
    },
    "variable": {
      "label": "変数操作 (Variable)",
      "description": "変数の値を更新するノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "targetVariable", "type": "string", "description": "対象変数" },
        { "key": "variableValue", "type": "string", "description": "代入・計算式" },
        { "key": "previousValue", "type": "any", "description": "一時保存値 (内部用)" }
      ]
    },
    "group": {
      "label": "グループ (Group)",
      "description": "複数のノードをまとめるコンテナ。",
      "properties": [
        { "key": "label", "type": "string", "description": "グループ名" },
        { "key": "expanded", "type": "boolean", "description": "展開/折りたたみ状態" },
        { "key": "contentWidth", "type": "number", "description": "コンテンツ幅" },
        { "key": "contentHeight", "type": "number", "description": "コンテンツ高さ" }
      ]
    },
    "jump": {
      "label": "ジャンプ (Jump)",
      "description": "別のノードへ接続線なしで移動するノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "jumpTarget", "type": "string", "description": "移動先ノードID" }
      ]
    },
    "memo": {
      "label": "メモ (Memo / Note)",
      "description": "シナリオに影響しないメモ書き。",
      "properties": [
        { "key": "label", "type": "string", "description": "タイトル" },
        { "key": "description", "type": "string", "description": "メモ内容" }
      ]
    },
    "sticky": {
      "label": "付箋 (Sticky)",
      "description": "キャンバスやノードに自由に貼れる付箋。",
      "properties": [
        { "key": "label", "type": "string", "description": "テキスト内容" },
        { "key": "targetNodeId", "type": "string", "description": "添付先ノードID (あれば)" }
      ]
    },
    "character": {
      "label": "キャラクター (Character)",
      "description": "キャラクター定義への参照を持つノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "表示名" },
        { "key": "referenceId", "type": "string", "description": "キャラクターデータID" }
      ]
    },
    "resource": {
      "label": "リソース (Resource)",
      "description": "リソース定義への参照を持つノード。",
      "properties": [
        { "key": "label", "type": "string", "description": "表示名" },
        { "key": "referenceId", "type": "string", "description": "リソースデータID" }
      ]
    }
  },
  "user_interface": {
    "header": {
      "elements": [
        { "label": "ロゴ (Logo)", "type": "branding", "trigger": "Click", "shortcut": "", "action": "ホームへ戻る (将来的な機能)", "visual": "紫から緑へのグラデーションテキスト (Cinzel Decorative)", "children": [] },
        { 
          "label": "デスクトップメニューバー (Desktop Menu Bar)",
          "type": "menu_bar",
          "trigger": "",
          "shortcut": "",
          "action": "",
          "children": [
            {
              "label": "File",
              "trigger": "Click",
              "shortcut": "",
              "action": "ファイルメニューを開く",
              "children": [
                { "label": "Save", "trigger": "Click", "shortcut": "Ctrl+S", "action": "現在のシナリオをJSONファイルとして保存", "children": [] },
                { "label": "Load", "trigger": "Click", "shortcut": "", "action": "JSONファイルを読み込んでシナリオを展開", "children": [] },
                { 
                  "label": "Load Sample", 
                  "trigger": "Hover / Click", 
                  "shortcut": "", 
                  "action": "サンプルサブメニューを開く", 
                  "children": [
                    { "label": "Story (物語形式)", "trigger": "Click", "shortcut": "", "action": "物語形式のサンプルシナリオをロード", "children": [] },
                    { "label": "Nested Group Nodes (入れ子グループ)", "trigger": "Click", "shortcut": "", "action": "複雑なグループ構造のサンプルをロード", "children": [] }
                  ] 
                },
                { 
                  "label": "Export", 
                  "trigger": "Hover / Click", 
                  "shortcut": "", 
                  "action": "エクスポートサブメニューを開く", 
                  "children": [
                    { "label": "Export Simple Text (.txt)", "trigger": "Click", "shortcut": "", "action": "プレーンテキストとしてエクスポート", "children": [] },
                    { "label": "Export Markdown (.md)", "trigger": "Click", "shortcut": "", "action": "Markdown形式でエクスポート", "children": [] }
                  ] 
                },
                { "label": "Reset", "trigger": "Click", "shortcut": "", "danger": true, "action": "全データを削除して初期状態に戻す", "children": [] }
              ]
            },
            {
              "label": "Edit",
              "trigger": "Click",
              "shortcut": "",
              "action": "編集メニューを開く",
              "children": [
                { 
                  "label": "Sticky Notes", 
                  "trigger": "Hover / Click", 
                  "shortcut": "", 
                  "action": "付箋サブメニューを開く", 
                  "children": [
                    { "label": "Show All Stickies", "trigger": "Click", "shortcut": "", "action": "全ての付箋を表示する", "children": [] },
                    { "label": "Hide All Stickies", "trigger": "Click", "shortcut": "", "action": "全ての付箋を非表示にする", "children": [] },
                    { "label": "Delete All Stickies", "trigger": "Click", "shortcut": "", "action": "全ての付箋を削除する", "children": [] },
                    { "label": "Delete Free Stickies", "trigger": "Click", "shortcut": "", "action": "ノードに紐付かない付箋を削除", "children": [] },
                    { "label": "Delete Node Stickies", "trigger": "Click", "shortcut": "", "action": "ノードに紐付く付箋を削除", "children": [] }
                  ] 
                },
                { 
                  "label": "Bulk Reveal", 
                  "trigger": "Hover / Click", 
                  "shortcut": "", 
                  "action": "公開設定サブメニューを開く", 
                  "children": [
                    { "label": "Reveal All Nodes", "trigger": "Click", "shortcut": "", "action": "全ノードを公開状態にする", "children": [] },
                    { "label": "Unreveal All Nodes", "trigger": "Click", "shortcut": "", "action": "全ノードを非公開状態にする", "children": [] }
                  ] 
                }
              ]
            },
            {
              "label": "View",
              "trigger": "Click",
              "shortcut": "",
              "action": "表示メニューを開く",
              "children": [
                { "label": "Zoom In", "trigger": "Click", "shortcut": "", "action": "ズームレベルを上げる (+)", "children": [] },
                { "label": "Zoom Out", "trigger": "Click", "shortcut": "", "action": "ズームレベルを下げる (-)", "children": [] },
                { "label": "Fit View", "trigger": "Click", "shortcut": "", "action": "全体が収まるように表示", "children": [] }
              ]
            },
            {
              "label": "Settings",
              "trigger": "Click",
              "shortcut": "",
              "action": "設定メニューを開く",
              "children": [
                { "label": "Switch Theme", "trigger": "Click", "shortcut": "", "action": "ライト/ダークテーマの切り替え", "children": [] },
                { "label": "Switch Language", "trigger": "Click", "shortcut": "", "action": "英語/日本語の切り替え", "children": [] },
                { 
                  "label": "Edge Style", 
                  "trigger": "Hover / Click", 
                  "shortcut": "", 
                  "action": "エッジの描画スタイル変更", 
                  "children": [
                    { "label": "Default (Bezier)", "trigger": "Click", "shortcut": "", "action": "ベジェ曲線", "children": [] },
                    { "label": "Straight", "trigger": "Click", "shortcut": "", "action": "直線", "children": [] },
                    { "label": "Step", "trigger": "Click", "shortcut": "", "action": "直角", "children": [] },
                    { "label": "SmoothStep", "trigger": "Click", "shortcut": "", "action": "丸みのある直角", "children": [] }
                  ] 
                }
              ]
            },
            {
              "label": "Help",
              "trigger": "Click",
              "shortcut": "",
              "action": "ヘルプメニューを開く",
              "children": [
                { "label": "Manual", "trigger": "Click", "shortcut": "", "action": "操作マニュアルを開く", "children": [] },
                { "label": "Update History", "trigger": "Click", "shortcut": "", "action": "更新履歴モーダルを開く", "children": [] },
                { "label": "About", "trigger": "Click", "shortcut": "", "action": "アプリ情報を表示", "children": [] }
              ]
            }
          ]
        },
        { 
          "label": "右側コントロール (Right Controls)", 
          "type": "control_group", 
          "trigger": "", 
          "shortcut": "", 
          "action": "", 
          "children": [
            { "label": "Undo", "trigger": "Click", "shortcut": "Ctrl+Z", "action": "操作を取り消す", "children": [] },
            { "label": "Redo", "trigger": "Click", "shortcut": "Ctrl+Y", "action": "取り消した操作をやり直す", "children": [] },
            { "label": "Mode Switch", "trigger": "Click", "shortcut": "", "action": "編集(Edit) / プレイ(Play) モードの切り替え", "children": [] }
          ]
        }
      ]
    },
    "sidebar": {
      "width": { "desktop": "320px", "mobile": "オーバーレイ (約256px)" },
      "tabs": [
        { "id": "menu", "label": "メニュー", "condition": "モバイルのみ", "trigger": "Tap", "shortcut": "", "action": "モバイルメニューを表示", "children": [] },
        { "id": "nodes", "label": "ノード / ゲームステート", "trigger": "Click", "shortcut": "", "action": "ノード一覧またはステータスビューを表示", "children": [] },
        { "id": "characters", "label": "キャラクター", "trigger": "Click", "shortcut": "", "action": "キャラクターリストを表示", "children": [] },
        { "id": "resources", "label": "リソース", "trigger": "Click", "shortcut": "", "action": "リソースリストを表示", "children": [] },
        { "id": "variables", "label": "変数", "trigger": "Click", "shortcut": "", "action": "変数リストを表示", "children": [] }
      ]
    },
    "canvas_interaction": {
      "selection": [
        { "label": "Click Node", "trigger": "Click", "shortcut": "", "action": "単一ノードを選択 (他は選択解除)", "children": [] },
        { "label": "Multi Select", "trigger": "Click", "shortcut": "Ctrl+Click / Cmd+Click", "action": "選択状態をトグル (複数選択)", "children": [] },
        { "label": "Deselect All", "trigger": "Click Pane", "shortcut": "", "action": "全ての選択を解除", "children": [] }
      ],
      "double_click": {
        "play_mode": [
          { "label": "Sticky Property", "trigger": "Double Click", "shortcut": "", "action": "プロパティパネルを開く", "target": "Sticky Node", "children": [] },
          { "label": "Jump Navigation", "trigger": "Double Click", "shortcut": "", "action": "ジャンプ先へ移動", "target": "Jump Node", "children": [] }
        ],
        "edit_mode": [
          { "label": "Mobile Node Property", "trigger": "Double Tap", "shortcut": "", "action": "プロパティパネルを開く", "target": "Any Node (Mobile)", "children": [] },
          { "label": "Jump Navigation", "trigger": "Double Click", "shortcut": "", "action": "ジャンプ先へ移動", "target": "Jump Node", "children": [] }
        ]
      },
      "context_menu": {
        "trigger": [
          { "device": "Desktop", "trigger": "Right Click", "shortcut": "", "action": "コンテキストメニューを開く", "children": [] },
          { "device": "Mobile", "trigger": "Long Press (500ms)", "shortcut": "", "action": "コンテキストメニューを開く", "children": [] }
        ],
        "items": [
          { "label": "Duplicate", "trigger": "Click", "shortcut": "", "condition": "編集モード & 付箋以外", "action": "ノードを複製する", "children": [] },
          { 
            "label": "Copy Text", 
            "trigger": "Hover / Click", 
            "shortcut": "", 
            "action": "テキストコピーサブメニュー", 
            "children": [
               { "label": "All", "trigger": "Click", "shortcut": "", "action": "全テキストをコピー", "children": [] },
               { "label": "Label", "trigger": "Click", "shortcut": "", "action": "ラベルをコピー", "children": [] },
               { "label": "Description", "trigger": "Click", "shortcut": "", "action": "説明文をコピー", "children": [] },
               { "label": "Value", "trigger": "Click", "shortcut": "", "action": "値をコピー", "children": [] },
               { "label": "Condition", "trigger": "Click", "shortcut": "", "action": "条件式をコピー", "children": [] },
               { "label": "Cases", "trigger": "Click", "shortcut": "", "action": "分岐ケースをコピー", "children": [] }
            ] 
          },
          { "label": "Mark Revealed/Unrevealed", "trigger": "Click", "shortcut": "", "condition": "付箋以外", "action": "公開/非公開状態を切り替える", "children": [] },
          { "label": "Hide Sticky", "trigger": "Click", "shortcut": "", "condition": "付箋である & ターゲットがある", "action": "付箋を非表示にする", "children": [] },
          { "label": "Add Sticky", "trigger": "Click", "shortcut": "", "condition": "付箋以外", "action": "ノードに付箋を追加する", "children": [] },
          { "label": "Show/Hide/Delete Stickies", "trigger": "Click", "shortcut": "", "condition": "付箋が添付されている", "action": "添付された付箋の操作", "children": [] },
          { "label": "Ungroup", "trigger": "Click", "shortcut": "", "condition": "グループである", "action": "グループを解除する", "children": [] },
          { "label": "Detach from Group", "trigger": "Click", "shortcut": "", "condition": "親グループがある", "action": "グループから離脱する", "children": [] },
          { "label": "Delete", "trigger": "Click", "shortcut": "Delete / Backspace", "condition": "編集モード OR 付箋", "action": "削除する", "children": [] },
          { "label": "Add Free Sticky", "trigger": "Click", "shortcut": "", "condition": "空白部分(Pane)", "action": "その場にフリー付箋を追加", "children": [] },
          { "label": "Reduplicate", "trigger": "Click", "shortcut": "", "condition": "空白部分(Pane) & 編集モード", "action": "直前に複製したノードを再度複製", "children": [] }
        ]
      }
    }
  },
  "implementation_report_inconsistencies": [
    {
      "feature": "更新履歴モーダル (Update History Modal)",
      "issue": "デスクトップの「Help」メニューには存在するが、モバイルの「Menu」タブ > Help セクションでは適切にリンクされていないか、特定のレスポンシブ状態で表示されない (Sidebar.tsx のモバイルメニュー構造で確認: Manual と About は存在するが、Update History が欠落している)。",
      "location": "Sidebar.tsx (Line 549)"
    },
    {
      "feature": "変数の型変更 (Variable Type Change)",
      "issue": "`updateVariableMetadata` 内のコードで、名前変更時の型変更を明示的に防止している (コメントに 'Just type change - DISALLOWED by user request' とある)。UIはこの制限を反映する必要がある。",
      "location": "scenarioStore.ts"
    }
  ]
}
